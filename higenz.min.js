
/* ==== Bảo vệ bản quyền ==== */
(function() {
  const allowedHost = 'chubang.blogspot.com';
  if (location.hostname !== allowedHost) {
    document.documentElement.innerHTML = '<div style="color:red;font-size:2em;text-align:center;margin-top:20%">Sai domain rồi bạn êi!</div>';
    setInterval(() => alert("Bạn đang sử dụng sai domain!"), 3000);
  }

  document.addEventListener('contextmenu', e => e.preventDefault());
  document.onkeydown = function(e) {
    if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) ||
        e.keyCode == 'J'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0))) ||
        (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0))) {
      return false;
    }
  };
})();

/* ==== Bookmark ==== */
document.querySelectorAll('.bookmark-btn').forEach(btn => {
  const postId = btn.dataset.id;
  const saved = JSON.parse(localStorage.getItem('bookmarks') || '[]');
  if (saved.includes(postId)) btn.classList.add('bookmarked');
  btn.addEventListener('click', () => {
    let bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
    if (bookmarks.includes(postId)) {
      bookmarks = bookmarks.filter(id => id !== postId);
      btn.classList.remove('bookmarked');
    } else {
      bookmarks.push(postId);
      btn.classList.add('bookmarked');
    }
    localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
  });
});

/* ==== Trending Modal ==== */
document.addEventListener("DOMContentLoaded", function () {
  const modal = document.querySelector(".trending-modal");
  const closeBtn = modal?.querySelector(".close-trending");
  if (modal) {
    setTimeout(() => modal.style.display = "block", 3000);
    closeBtn?.addEventListener("click", () => modal.style.display = "none");
    window.addEventListener("click", e => {
      if (e.target == modal) modal.style.display = "none";
    });
  }
});

/* ==== Firebase Rating ==== */
(function() {
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID",
    measurementId: "YOUR_MEASUREMENT_ID"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  window.renderStarRating = function(postId) {
    const ratingContainer = document.getElementById('rating-' + postId);
    if (!ratingContainer) return;
    const stars = Array.from(ratingContainer.querySelectorAll('.star'));
    const resetBtn = ratingContainer.querySelector('.reset-rating');
    const statsEl = ratingContainer.querySelector('.rating-stats');

    let rated = localStorage.getItem(`rated_${postId}`);
    let currentRating = 0;

    const updateStats = (data) => {
      const count = data.count || 0;
      const total = data.total || 0;
      const avg = count ? (total / count).toFixed(1) : "0.0";
      statsEl.innerText = `Đánh giá: ${avg} ★ (${count} lượt)`;
    };

    db.collection("ratings").doc(postId).onSnapshot(doc => {
      if (doc.exists) updateStats(doc.data());
    });

    stars.forEach((star, i) => {
      star.addEventListener('click', () => {
        if (rated) return alert("Bạn đã đánh giá bài viết này rồi.");
        const rating = i + 1;
        db.runTransaction(async (t) => {
          const docRef = db.collection("ratings").doc(postId);
          const docSnap = await t.get(docRef);
          const data = docSnap.exists ? docSnap.data() : { count: 0, total: 0 };
          t.set(docRef, {
            count: data.count + 1,
            total: data.total + rating
          });
        }).then(() => {
          localStorage.setItem(`rated_${postId}`, 'true');
        });
      });
    });

    resetBtn?.addEventListener('click', () => {
      db.collection("ratings").doc(postId).set({ count: 0, total: 0 });
      localStorage.removeItem(`rated_${postId}`);
    });
  };
})();

/* ==== Owl Carousel Slider ==== */
document.addEventListener("DOMContentLoaded", function () {
  if (typeof jQuery !== 'undefined' && typeof jQuery.fn.owlCarousel === 'function') {
    jQuery(".product-slider").owlCarousel({
      items: 1,
      loop: true,
      autoplay: true,
      autoplayTimeout: 3000,
      dots: true,
      nav: true
    });
  } else {
    console.warn("jQuery hoặc OwlCarousel chưa được tải.");
  }
});
